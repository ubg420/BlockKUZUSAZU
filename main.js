var barsize,bar,block,ball,eball,ballGroup,eballGroup,blockGroup,point,gameflg,speed,SCREEN_WIDTH=450,SCREEN_HEIGHT=800,SCREEN_CENTER_X=SCREEN_WIDTH/2,SCREEN_CENTER_Y=SCREEN_HEIGHT/2,UI_DATA={main:{children:[{type:"Label",name:"score",fontSize:32,fillStyle:"White",shadowColor:"blue",shadowBlur:4,x:20,y:30}]}},ASSETS={title:"./image/title.png",1:"./image/1.png",2:"./image/2.png"},ballsize=10,combo=0,RESULT_PARAM={score:0,msg:"守りたい。そのブロック",url:"http://cachacacha.com/BlockKUZUSAZU/",hashtags:"ブロック崩さぬ",width:SCREEN_WIDTH,height:SCREEN_HEIGHT,related:"tmlib.js Tutorial testcording"};tm.preload((function(){})),tm.main((function(){var t=tm.app.CanvasApp("#world");t.resize(SCREEN_WIDTH,SCREEN_HEIGHT),t.fitWindow();var i=tm.app.LoadingScene({assets:ASSETS,nextScene:TitleScene});t.replaceScene(i),t.run()})),tm.define("TitleScene",{superClass:"tm.app.TitleScene",init:function(){this.superInit({title:"ブロック崩さぬ",width:SCREEN_WIDTH,height:SCREEN_HEIGHT}),this.title=tm.app.Sprite("title",SCREEN_WIDTH,SCREEN_HEIGHT).addChildTo(this),this.title.position.set(SCREEN_WIDTH/2,SCREEN_HEIGHT/2),this.addEventListener("pointingend",(function(t){t.app.replaceScene(MainScene())}))}}),tm.define("EndScene",{superClass:"tm.app.ResultScene",init:function(){RESULT_PARAM.score=point,this.superInit(RESULT_PARAM),this.Name=tm.app.Label("サイトへ").addChildTo(this),this.Name.setPosition(320,740).setFillStyle("white").setFontSize(25);var t=this.tweetButton=tm.ui.GlossyButton(180,40,"#32cd32","かちゃコム").addChildTo(this);t.setPosition(350,770),t.onclick=function(){window.open("http://cachacacha.com")},this.a=tm.app.Label("アプリもあるでよ").addChildTo(this),this.a.setPosition(85,60).setFillStyle("hsla(198, 80%, 80%, 8.0)").setFontSize(28);var i=tm.app.Sprite("1",130,130).addChildTo(this);i.setPosition(140,160),i.onclick=function(){window.open("http://cachacacha.com/BlockKUZUSAZU/a.html")};var s=tm.app.Sprite("2",130,130).addChildTo(this);s.setPosition(310,160),s.onclick=function(){window.open("https://play.google.com/store/apps/details?id=me.flowork.donotbreak&hl=ja")}},onnextscene:function(t){t.target.app.replaceScene(MainScene())}}),tm.define("MainScene",{superClass:"tm.app.Scene",init:function(){this.superInit(),blockGroup=tm.app.CanvasElement().addChildTo(this),ballGroup=tm.app.CanvasElement().addChildTo(this),eballGroup=tm.app.CanvasElement().addChildTo(this),gameflg=1,barsize=45,point=0,combo=0,this.LR=0,this.vx=0,this.vy=0,this.speed=1,this.timer=1,this.remit=30,this.rtimer=1,this.rspeed=80,this.danvx=0,this.danvy=0,this.danspeed=.1,this.dancnt=0,this.danend=3,this.danvx_remit=4.5,this.dantimer=0,this.danremit=2,this.etimer=1,this.ebouns=1500,this.nextmode=1,this.btimer=1;for(var t=7,i=60,s=360,e=1;e<=7;e+=1){for(var h=1;h<=8;h+=1)(block=blocks("hsla({0}, 80%, 50%, 0.75)".format(s)).addChildTo(blockGroup)).x=t,block.y=i,t+=55;i+=25,t=7,s-=40}bar=barclass(),this.addChild(bar),this.fromJSON(UI_DATA.main),this.score.text=point,this.Combolabel=tm.app.Label("").addChildTo(this),this.Combolabel.setPosition(40,500).setFillStyle("hsla(123, 80%, 50%, 8.0)").setFontSize(40),this.mode=tm.app.Label("").addChildTo(this),this.mode.setPosition(40,300).setFillStyle("hsla(60, 80%, 50%, 8.0)").setFontSize(70),this.gameovertimer=0},update:function(t){switch(gameflg){case 1:this.btimer%this.remit==0&&(this.LR=rand(1),this.vy=10,this.vx=(rand(200)-100)/10,ball=balls(this.LR,this.vx*this.speed,this.vy*this.speed,0).addChildTo(ballGroup),this.btimer=1),this.rtimer>this.rspeed&&this.remit>5&&(this.remit-=1,this.rspeed+=3,this.remit<20&&(this.rspeed+=10),this.rtimer=0),this.timer%500==0&&(gameflg=2,this.speed+=.1),this.timer%this.ebouns==0&&(gameflg=9,this.nextmode=3,this.ebouns+=500,this.timer=1),++this.timer,++this.rtimer,++this.btimer;break;case 2:this.dantimer%2==0&&(this.danvy=4,ball=balls(this.LR,this.danvx,this.danvy,1).addChildTo(ballGroup)),this.danvx_remit>this.danvx?this.danvx+=this.danspeed:(0==this.LR?this.LR=1:this.LR=0,this.danvx=0,this.dancnt++),this.dancnt>=this.danend&&(gameflg=9,this.nextmode=1,this.dancnt=0,this.danend++,this.danspeed+=.01),this.dantimer++;break;case 3:barsize=80,this.mode.text="入れ食い\nボーナス！！！",this.etimer%2==0&&(this.LR=rand(1),this.evy=.5,this.evx=rand(80)/10,eball=eballs(this.LR,this.evx,this.evy).addChildTo(ballGroup)),this.etimer++,this.etimer>500&&(this.etimer=1,this.mode.text="",barsize=45,gameflg=9,this.nextmode=1);break;case 9:this.bg=ballGroup.children,this.ballNASI=0;var i=this;this.bg.each((function(t){i.ballNASI=1})),0==this.ballNASI&&(gameflg=this.nextmode);break;case 0:this.Combolabel.text="",this.mba=ballGroup.children,this.mba.each((function(t){t.remove()})),0==this.gameovertimer&&(this.mbc=blockGroup.children,this.mbc.each((function(t){t.vy=rand(40)-10,t.vx=rand(20)-10,t.rotation=30}))),this.gameovertimer>40&&this.mbc.each((function(t){t.remove()})),this.gameovertimer>70&&t.replaceScene(EndScene()),++this.gameovertimer}this.score.text="SCORE:"+point,this.Combolabel.text=combo>0?combo+" Combo!":""}});var blocks=tm.createClass({superClass:tm.app.CanvasElement,init:function(t){this.superInit(),this.color=t,this.width=55,this.height=25,this.vx=0,this.vy=0},update:function(t){this.L=this.x,this.R=this.x+this.width,this.T=this.y,this.B=this.y+this.height+3,this.x+=this.vx,this.y+=this.vy},draw:function(t){t.globalCompositeOperation="lighter",t.fillStyle=this.color,t.fillRect(0,0,50,20,8)}}),balls=tm.createClass({superClass:tm.app.CanvasElement,init:function(t,i,s,e){this.superInit(),this.color="hsla(10, 75%, 100%, 1)",this.flg=0,this.L,this.R,this.T,this.B,this.ballflg=e,0==t?(this.x=30,this.vx=i):(this.x=420,this.vx=-1*i),this.y=280,this.vy=s},update:function(t){this.L=this.x+4,this.R=this.x+6,this.T=this.y+4,this.B=this.y+6,this.y>=bar.y-this.vy&&this.y<=bar.y+5&&(this.x>=t.pointing.x-barsize&&this.x<=t.pointing.x+barsize?0==this.flg&&(point+=100+10*combo,combo++,this.flg=1):(combo=0,this.vy*=-1,0==this.ballflg?this.color="hsla(18, 100%, 70%, 1)":1==this.ballflg&&(this.color="hsla(360, 75%, 50%, 0.8)")));var i=blockGroup.children,s=this;i.each((function(t){clash(s,t)&&(s.vy*=-1,s.vx*=-1,t.remove(),s.ballflg++)})),(this.L<5||this.R>SCREEN_WIDTH)&&(this.vx*=-1),this.y>SCREEN_HEIGHT&&this.remove(),this.y<0&&(gameflg=0,this.remove()),this.ballflg>=2&&this.remove(),this.y+=this.vy,this.x+=this.vx},draw:function(t){t.globalCompositeOperation="lighter",t.fillStyle=this.color,t.fillCircle(0,0,ballsize)}}),barclass=tm.createClass({superClass:tm.app.CanvasElement,init:function(t){this.superInit(),this.color=t,this.y=650,this.WD=50,this.LWD=SCREEN_WIDTH/2-barsize,this.RWD=SCREEN_WIDTH/2+barsize},update:function(t){t.pointing.x+barsize/2>0&&t.pointing.x<SCREEN_WIDTH-barsize/2&&(this.LWD=t.pointing.x-barsize,this.RWD=t.pointing.x+barsize)},draw:function(t){t.globalCompositeOperation="lighter",t.fillStyle="hsla(0, 75%, 100%, 1)",t.fillRect(0,0,this.LWD,10,8),t.fillRect(this.RWD,0,SCREEN_WIDTH-this.RWD,10,8)}}),eballs=tm.createClass({superClass:tm.app.CanvasElement,init:function(t,i,s){this.superInit(),this.v=tm.geom.Vector2(0,0),0==t?(this.x=30,this.v.x=i):(this.x=420,this.v.x=-1*i),this.y=280,this.vy=s,this.flg=0,this.timer=1,this.color="hsla(100, 100%, 100%, 1)"},update:function(t){this.v.y+=this.vy,(this.x<5||this.x>SCREEN_WIDTH)&&(this.x=5,this.v.x*=-1,this.vx*=-1),this.y+10>=bar.y&&this.y+10<=bar.y+this.v.y&&(this.x>=t.pointing.x-barsize&&this.x<=t.pointing.x+barsize?0==this.flg&&(point+=50+combo,combo++,this.flg=1):this.v.y*=-.6),this.position.add(this.v),this.timer>130&&(this.color="hsla(360, 75%, 50%, 0.8)",this.timer>160&&this.remove()),this.y>SCREEN_HEIGHT&&this.remove(),this.timer++},draw:function(t){t.globalCompositeOperation="lighter",t.fillStyle=this.color,t.fillCircle(0,0,ballsize)}});function clash(t,i){return t.L<=i.R&&t.R>=i.L&&t.T<=i.B&&t.B>=i.T}function rand(t){return Math.floor(Math.random()*(t+1))}